
### TCP 三次握手

TCP 连接使用三次握手的原因：避免历史错误连接的建立，减少通信双方不必要的资源消耗

#### 如果建立连接时的通信只有两次？  

一旦发送方在发出建立连接的请求之后，就没办法撤回这个请求。当在网络状况复杂或者比较差的环境中，发送方没有收到应答，连续
发送请求连接请求，接收方只能接收或拒绝请求，导致发送方无法知道当前的连接状态（可能在建立后，接收方返回多个拒绝请求）。
所以在三次连接中引入了 RST 消息标志，接收方当收到请求时会将发送方发来的 `SEQ + 1` 发送回接收方，由接收方判断当前连接是否
为历史连接：

* 如果当前连接是历史连接，即 `SEQ` 过期或者超时，那么发送方就会直接发送 `RST` 控制消息中止这一次连接
* 如果当前连接不是历史连接，那么发送方就会发送 `ACK` 控制消息，通信双方就会成功建立连接

使用三次握手和 RST 控制消息是将是否建立连接的控制权交由发送方，因为只有发送方有足够的上下文判断当前连接是否是错误的或者是
过期的。

#### 同时维护着 初始序列号

* 数据包被发送方多次发送造成数据重复 （重复去除）
* 数据包在传输的过程中被路由或者其它节点丢失（重新发送）
* 数据包在接收方可能无法按照发送顺序（重排序）

### DNS (Domain Name System)

1. 先由本地的 DNS Client 向 DNS Resolver 解析器发出解析 `heiku.github.io` 的请求
2. DNS Resolver 首先向就近的根 DNS 服务器 `.` 请求顶级域名 DNS 服务的地址
3. 拿到顶级域名 DNS 服务 `io.` 的地址之后会向顶级域名服务请求负责 `github.io.` 域名解析的命名服务
4. 得到授权的 DNS 命名服务就可以根据请求的具体的主机记录直接向该服务请求域名对应的 IP 地址

（.）根域名、(io.)顶级域名、（github.io）二级域名、（heiku.github.com）子域名

#### 实现 （TCP & UDP）

DNS 查询的类型不知包含 A 记录（ip指向）、CNAME 记录（别名）等常见查询，还包括 AXFR 类型的特殊查询，这种特殊查询主要用于
 _DNS 区域传输_， 它的作用就是在多个命名服务器之间快速迁移记录，由于查询返回的响应比较大，所以会使用 TCP 协议进行传输
数据包。
 
在 _域名查找_ 的过程中，因为数据量小，且不需要稳定的连接，同时 TCP 在建立连接（三次握手），销毁连接（四次握手）会带来很大
的额外开销，这种情况在 DNS 解析器递归地与多个命名服务器进行通信时加倍开销。

但是，在区域查询中，因为一个 UDP 数据包的大小最多可以达到 64KB，虽然对于 DNS 查询已经时一个很大的数值（通常20），
但在实际生产中，一旦数据包中的数据超过传送链路中的最大单元（MTU，单个数据包大小的上限，一般为 1500 字节），当前数据包
就可能被分片传输、丢弃、部分的网络设备甚至会拒绝处理包请求，导致 UDP 协议在 _区域传输_ 中的不稳定，所以使用 TCP。



### 引用

[为什么 DNS 使用 UDP 协议 · Why's THE Design?](https://draveness.me/whys-the-design-dns-udp-tcp)